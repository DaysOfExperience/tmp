# 数据链路层VS网络层 

![image-20231120150127429](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120150127429.png)

![image-20231120150315085](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120150315085.png)IP：根据目的IP地址，在复杂的网络环境中确定一条合适的IP数据包传输路径

而主机B到路由器F，F到G，G到H等等的局域网数据转发的问题，都是**由数据链路层在这个局域网中完成转发任务的。**

----

**数据链路层的主要功能就是负责局域网中相邻设备之间的数据传输 **

网络层是点对点之间的通信。主要通过IP协议描述起点到终点。而链路层则是对网络层的补充，负责在起点到终点的路径中，**每一个相邻节点的数据传输。**

网络层主要关心的是从起点到终点

![image-20231120150443823](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120150443823.png)

链路层则关心的是其中路径上的每一个相邻节点的通信

![image-20231120150459104](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120150459104.png)

# 以太网

## 以太网概念

"以太网" 不是一种具体的网络, 而是一种技术标准;(使用最广泛的局域网技术) **既包含了数据链路层的内容, 也包含了一些物理层的内容.** 例如: 规定了网络拓扑结构, 访问控制方式, 传输速率等;

例如以太网中的网线必须使用双绞线; 传输速率有10M, 100M, 1000M等;

**以太网是当前应用最广泛的局域网技术;** 和以太网并列的还有令牌环网, 无线LAN等;

故上方所说的局域网转发时一个节点到另一个节点的转发，本质都是在以太网中进行的。

## 以太网的帧格式(协议格式)

也可以称之为MAC帧

![image-20231120150804702](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120150804702.png)

- **48位源地址和目的地址**：表示发送端/接收端的MAC地址，**用于描述识别相邻的设备**。是指网卡的硬件地址(也叫MAC地址), 长度是48位, 是在网卡出厂时固化的
- **16位帧协议类型字段**：有三种值，分别对应IP、ARP、RARP;分别对应0800 0806 8035
- **32位FCS**：帧尾，包含校验和在内。

**MAC地址**

MAC地址即局域网中相邻设备定位的地址，也就是**物理网卡的硬件地址**，标识每一块网卡，在两块网卡之间的数据传输起到作用。

**MAC地址用来识别数据链路层中相连的节点（标识数据链路层中的主机的唯一性~）**

长度为48位, 即6个字节. 一般用16进制数字加上冒号的形式来表示(例如: 08:00:27:03:fb:19)

在网卡出厂时就确定了, 不能修改. mac地址通常是唯一的

IP地址描述的是路途总体的 起点 和 终点; MAC地址描述的是路途上的每一个局域网区间的起点和终点

> 目的地址和源地址都是MAC地址，类型标识了数据链路层进行解包之后，将有效载荷交给上层的谁，比如交给IP层（则有效载荷就是IP报文），还是ARP层（后面说ARP协议）
>
> 报头定长，可以进行解包，向上分用依据的就是类型字段的内容。

## 局域网通信原理

![image-20231120151242855](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120151242855.png)

**局域网内通信时，不管是两个主机之间，还是主机与路由器之间，都需要数据链路层封装MAC帧，来进行局域网转发。**

这个过程就像在教室内，任意两个人进行交流一样（大声交流，不是小声交流），这里比如H1发送数据帧后，这个局域网中所有主机都会收到这个MAC帧， 由数据链路层进行解析，发现目的MAC地址不是自己，则就会直接丢弃。

因为可能存在两个主机同时发送数据帧的情况，故**MAC数据帧在以太网中传输时可能发生碰撞**，此时，会有碰撞避免算法，比如发送方知道自己发出的MAC帧发生了碰撞，**就随机等待若干时长之后再进行重传**（所以严格来说，除了TCP有可靠性，数据链路层也有可靠性策略存在）

故

- 局域网内主机越少越好（更小概率发生数据碰撞）
- 局域网内节点发送数据帧时，数据帧越短越好~

所以，回归到之前讲IP时，说存在MTU限制，就是因为数据链路层因为物理原因有限制，这里其实就是根本原因之一

在网络转发过程中，目的IP不会变，MAC数据帧的源MAC和目的MAC会变。

# MTU

## MTU

**MTU（Maximum Transmission Unit）最大传输单元（MAC帧的有效载荷的最大长度）**

以太网帧中的数据长度规定: 最小46字节, 最大1500字节（这里的数据其实就是IP报文 或 ARP报文）(当ARP数据包的长度不够46字节, 要在后面补填充位)

**最大值1500称为以太网的最大传输单元(MTU)**, 不同的网络类型有不同的MTU

![image-20231120152126672](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120152126672.png)

## MTU对IP协议的影响

由于数据链路层MTU的限制, 对于较大的IP数据报要进行分包（分片）

> 而IP数据报的大小又是直接由传输层的数据段的大小决定的, 也就是TCP报文大小及UDP报文大小

## MTU对UDP协议的影响

一旦UDP携带的数据超过1472(1500 - 20(IP首部) - 8(UDP首部)), 那么就会由于MTU的限制, 在网络层分成多个IP数据报

这多个IP数据报有任意一个丢失, 都会引起接收端网络层重组失败. 那么这就意味着, **如果UDP数据段在网络层被分片, 整个数据被丢失的概率就大大增加了.**

所以这时候就需要我们在应用层使用UDP协议的时候就需要考虑到这个问题，将UDP数据段按照计算的大小进行分包处理。避免出现网络层分片的现象

## MTU对TCP协议的影响

**TCP的单个数据段的最大有效载荷长度, 称为MSS(Max Segment Size), 即最大报文段长度;（指的是TCP的有效载荷，即应用层数据）**

**TCP在三次握手建立连接的过程中, 通信双方会进行MSS协商.** : 双方在发送SYN的时候会在TCP头部写入自己能支持的MSS值. 然后双方得知对方的MSS值之后, 选择较小的作为最终MSS. (MSS的值就是在TCP首部的40字节变长选项中)

**因为TCP是面向字节流的传输，传输控制协议, 所以每次发送数据时，其就从发送缓冲区中取出不大于MSS的数据进行发送，也就是说, TCP在传输层会自动进行数据的分片处理， 所以其在网络层不会分片。**

> NB, 传输控制协议

![image-20231120152339269](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120152339269.png)

# ARP协议

> 注意，之前讲MAC帧时格式时，发现MAC帧里的类型字段，不仅仅标识着IP，还有ARP，也就是MAC帧的有效载荷不一定为IP报文，还有可能是ARP报文。
>
> **同时，在局域网中，当某一个路由器得到数据报，由目的IP决定转发给下一跳的X路由器时，需要由数据链路层封装MAC帧，但是，此时X路由器的MAC地址是不知道的，因此若想要封装MAC帧转发给X路由器，必须先知道其MAC地址。ARP协议就是用来解决此问题的。**

在进行网络通信时，网络层只给出了起点与终点的IP地址，那么数据链路层又是怎么通过IP地址来获取路径中每一个相邻设备的MAC地址呢？答案就是使用了ARP协议。

**在同一网段(局域网)中，通过目标节点IP地址，获取对方的MAC地址 -- ARP, 地址解析协议（Address Resolution Protocol）（局域网协议）**

> ARP协议是一种介于以太网MAC层和网络层之间的协议。且严格来说属于数据链路层（介于数据链路层和网络层之间的协议;）

## ARP协议格式

![image-20231120154453774](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120154453774.png)

![image-20231120154636960](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120154636960.png)

硬件类型指链路层网络类型, 1为以太网; 协议类型指要转换的地址类型, 0x0800为IP地址; 硬件地址长度对于以太网地址为6字节; 协议地址长度对于IP地址为4字节;

操作类型 - op字段 1表示ARP请求, 2表示ARP应答

## ARP协议的工作流程

> ARP请求+ARP应答的过程

假设主机A的IP为IP_A，MAC地址为MAC_A，主机D的IP为IP_D，MAC地址未知。此时AD主机在同一局域网中，由主机A发起ARP请求，再由主机D发起ARP应答，从而由主机A获取主机D的MAC地址。

下面是流程

![image-20231120155529891](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120155529891.png)

主机A由ARP层封装ARP报文请求，向下交付给MAC层，封装为MAC帧。因为此时不知道主机D的MAC地址，故其中的目标以太网地址设为全F，表示这是一个广播地址**（MAC帧首部的目的地址填FF:FF:FF:FF:FF:FF表示广播）**。在局域网中，每一个主机都会收到这个广播MAC帧，此时MAC层必须处理：先解包，然后向上交付，<u>因为每个主机的MAC层都无法直接获知这个MAC帧是否是发送给自己的</u>。根据0806，交付给arp层，arp层收到后，看到op是1，也就是arp请求。<u>再看目的IP地址</u>，若发现是发给自己的, 则继续后续ARP应答, 若不是则直接丢弃此报文

主机D再进行构建ARP应答，此时op为2，且目标IP，目标以太网地址，发送端IP，发送端以太网地址都已知。<u>此时，这不再是一个广播，而是一个**定向的局域网MAC帧**。但是，局域网中每一个主机仍会收到这个MAC帧</u>. 其他主机收到之后，在MAC层对比目标MAC地址，不是发给自己的直接丢弃。主机A收到之后，MAC层解包，0806，交付给上层的arp层。自此主机A获取到了主机D的MAC地址，可以在主机A内部构建此IP：MAC地址的映射。

总结

1. arp请求和arp应答的过程为：1. 先广播arp请求（目的MAC地址为全F） 2. 再定向1v1发送arp应答。（以太网帧首部的硬件地址填FF:FF:FF:FF:FF:FF表示广播）

2. 局域网中，任何一个主机收到arp时，可能是一个应答，也可能是一个请求。看arp报文的op字段

3. arp请求的非接收主机在arp层丢弃。arp应答的非接收主机在MAC层丢弃。（广播和定向导致）

4. <u>arp请求成功之后，请求方会暂时将IP : MAC地址的映射关系保存下来。缓存时间一般是20分钟, 因为IP地址不是固定的, 故并不是永久保存~</u>

5. arp的过程并非只发生在目标主机的最终子网处，在网络传输的路径过程中随时可能发生。

6. 每台主机都维护一个ARP缓存表, 可以用`arp -a`命令查看。缓存表中的表项有过期时间(一般为20分钟), 如果20分钟内没有再次使用某个表项, 则该表项失效, 下次局域网通信时要再发ARP请求来获得目的主机的硬件地址.

**ARP缓存表中的缓存为什么只存在一段时间后就会失效？**

这个主要涉及到MAC地址与IP地址的映射原理。**因为现在的IP地址基本都是DHCP动态分配的**，主机发送DHCP请求给路由器，路由器收到后给主机**动态分配IP地址**。而IP地址改变后，原来的映射关系就会发生变化，所以ARP缓存不能存在太长时间，需要及时更新。

## ARP欺骗

从上面ARP协议的工作流程可以看出，ARP请求广播是具有风险的。如果在局域网中有恶意的主机，其收到了我们的**ARP广播请求**，他此时就可以伪装成我们的目标主机IP地址，将他的MAC地址响应给我们，此后我们就会将数据发送给他，导致数据被截获。

**解决的方法也很简单，在防火墙中设置一个MAC白名单即可，只将数据发送给局域网中信任的设备即可。**

![image-20231120160237683](https://cdn.jsdelivr.net/gh/DaysOfExperience/blogImage@main/img/image-20231120160237683.png)

通过不断发送arp应答，欺骗主机A和B，修改A存储的B的MAC地址，B存储的A的MAC地址。（http/https 

**arp攻击**：让某主机上不了网：给目标主机发送arp应答，ip为主机所连路由器IP，MAC地址为一个错误的。这样这个主机发出的MAC帧，路由器就收不到了，因为其中的目的MAC地址是错误的。